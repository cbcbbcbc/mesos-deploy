version: '2'
services:
 zookeeper:
  image: mesoscloud/zookeeper:3.4.8-centos-7
  network_mode: host
  restart: always
  environment:
    - MY_ID=${ZOO_MY_ID}
    - SERVERS={MASTER0_IP},${MASTER1_IP},${MASTER2_IP}
  volumes:
    - zk-data:/data
    - zk-datalog:/datalog
 flanneld:
  image: registry.cn-hangzhou.aliyuncs.com/omega-reg/flannel:v0.6.2-amd64
  network_mode: host
  restart: always
  privileged: true
  volumes:
   - /dev/net:/dev/net
   - /run/flannel:/run/flannel
  environment:
   - "affinity:container!=*flanneld*"
  command: /opt/bin/flanneld --etcd-endpoints=http://${MASTER0_IP}:2379,http://${MASTER1_IP}:2379,http://${MASTER2_IP}:2379 --ip-masq=false  --iface=${LOCAL_IP}
 etcd:
  image: registry.cn-hangzhou.aliyuncs.com/omega-reg/etcd:3.0.4
  network_mode: host
  restart: always
  volumes:
   - etcd-data:/var/etcd/data
  environment:
   - "affinity:container!=*etcd*"
   - ETCD_INITIAL_CLUSTER="etcd0=http://${MASTER0_IP}:2380,etcd1=http://${MASTER1_IP}:2380,etcd2=http://${MASTER2_IP}:2380"
   - ETCD_INITIAL_CLUSTER_STATE=new
   - ETCD_INITIAL_CLUSTER_TOKEN=my-token
   - ETCD_NAME=${ETCD_NAME}
   - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://${LOCAL_IP}:2380
   - ETCD_LISTEN_PEER_URLS=http://${LOCAL_IP}:2380
   - ETCD_LISTEN_CLIENT_URLS=http://${LOCAL_IP}:2379,http://127.0.0.1:2379
   - ETCD_ADVERTISE_CLIENT_URLS=http://${LOCAL_IP}:2379
  command: /usr/local/bin/etcd 
 dnsmasq:
  image: andyshinn/dnsmasq:2.75
  network_mode: host
  cap_add: 
   - NET_ADMIN
  restart: always
  command: -S /consul/${LOCAL_IP}#8600  --log-facility=-
  environment:
   - "affinity:container!=*dnsmasq*"
volumes:
  etcd-data:
  zk-data:
  zk-datalog:
